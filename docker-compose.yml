version: '3.8'

services:
  # ============================================
  # REVERSE PROXY
  # ============================================
  traefik:
    image: traefik:v3.0
    container_name: openbiz_traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/certs:/certs
    networks:
      - openbiz_frontend
    restart: unless-stopped

  # ============================================
  # WEB SERVER (Frontend)
  # ============================================
  nginx:
    image: nginx:1.25-alpine
    container_name: openbiz_nginx
    volumes:
      - ./src:/var/www/html:ro
      - ./docker/nginx/conf.d/app.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - app
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.openbiz.rule=Host(`openbiz.local`)"
      - "traefik.http.services.openbiz.loadbalancer.server.port=80"
    networks:
      - openbiz_frontend
      - openbiz_backend
    restart: unless-stopped

  # ============================================
  # PHP APPLICATION
  # ============================================
  app:
    build:
      context: ./docker/php
      dockerfile: Dockerfile
      args:
        PHP_VERSION: 8.3
        NODE_VERSION: 20
    container_name: openbiz_app
    working_dir: /var/www/html
    volumes:
      - ./src:/var/www/html
      - ./docker/php/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
    environment:
      APP_ENV: ${APP_ENV:-local}
      APP_DEBUG: ${APP_DEBUG:-true}
      DB_HOST: mysql
      DB_DATABASE: ${DB_DATABASE:-openbiz}
      DB_USERNAME: ${DB_USERNAME:-openbiz}
      DB_PASSWORD: ${DB_PASSWORD:-secret}
      REDIS_HOST: redis
      CACHE_DRIVER: redis
      QUEUE_CONNECTION: redis
      SESSION_DRIVER: redis
      FILESYSTEM_DISK: minio
      AWS_ENDPOINT: http://minio:9000
      AWS_ACCESS_KEY_ID: ${MINIO_ACCESS_KEY:-openbiz}
      AWS_SECRET_ACCESS_KEY: ${MINIO_SECRET_KEY:-secret123}
      AWS_BUCKET: ${MINIO_BUCKET:-openbiz}
      AWS_USE_PATH_STYLE_ENDPOINT: "true"
      MEILISEARCH_HOST: http://meilisearch:7700
      BROADCAST_DRIVER: pusher
      PUSHER_HOST: soketi
      PUSHER_PORT: 6001
      PUSHER_SCHEME: http
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_started
    networks:
      - openbiz_backend
    restart: unless-stopped

  # ============================================
  # QUEUE WORKER (Horizon)
  # ============================================
  worker:
    build:
      context: ./docker/php
      dockerfile: Dockerfile
    container_name: openbiz_worker
    working_dir: /var/www/html
    command: php artisan horizon
    volumes:
      - ./src:/var/www/html
    environment:
      APP_ENV: ${APP_ENV:-local}
      DB_HOST: mysql
      DB_DATABASE: ${DB_DATABASE:-openbiz}
      DB_USERNAME: ${DB_USERNAME:-openbiz}
      DB_PASSWORD: ${DB_PASSWORD:-secret}
      REDIS_HOST: redis
    depends_on:
      - app
      - redis
    networks:
      - openbiz_backend
    restart: unless-stopped

  # ============================================
  # SCHEDULER (Cron)
  # ============================================
  scheduler:
    build:
      context: ./docker/php
      dockerfile: Dockerfile
    container_name: openbiz_scheduler
    working_dir: /var/www/html
    command: >
      sh -c "while true; do
        php artisan schedule:run --verbose --no-interaction &
        sleep 60
      done"
    volumes:
      - ./src:/var/www/html
    depends_on:
      - app
    networks:
      - openbiz_backend
    restart: unless-stopped

  # ============================================
  # DATABASE
  # ============================================
  mysql:
    image: mysql:8.0
    container_name: openbiz_mysql
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootsecret}
      MYSQL_DATABASE: ${DB_DATABASE:-openbiz}
      MYSQL_USER: ${DB_USERNAME:-openbiz}
      MYSQL_PASSWORD: ${DB_PASSWORD:-secret}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - openbiz_backend
    restart: unless-stopped

  # ============================================
  # CACHE & QUEUE
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: openbiz_redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - openbiz_backend
    restart: unless-stopped

  # ============================================
  # OBJECT STORAGE (S3-compatible)
  # ============================================
  minio:
    image: minio/minio:latest
    container_name: openbiz_minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-openbiz}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-secret123}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - openbiz_backend
      - openbiz_storage
    restart: unless-stopped

  # ============================================
  # SEARCH ENGINE
  # ============================================
  meilisearch:
    image: getmeili/meilisearch:v1.6
    container_name: openbiz_meilisearch
    environment:
      MEILI_MASTER_KEY: ${MEILISEARCH_KEY:-masterkey123}
      MEILI_ENV: development
    volumes:
      - meilisearch_data:/meili_data
    ports:
      - "7700:7700"
    networks:
      - openbiz_backend
    restart: unless-stopped

  # ============================================
  # WEBSOCKET SERVER
  # ============================================
  soketi:
    image: quay.io/soketi/soketi:1.6-16-debian
    container_name: openbiz_soketi
    environment:
      SOKETI_DEBUG: "1"
      SOKETI_DEFAULT_APP_ID: openbiz
      SOKETI_DEFAULT_APP_KEY: openbiz-key
      SOKETI_DEFAULT_APP_SECRET: openbiz-secret
    ports:
      - "6001:6001"
      - "9601:9601"
    networks:
      - openbiz_backend
    restart: unless-stopped

  # ============================================
  # MAIL (Development)
  # ============================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: openbiz_mailhog
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - openbiz_backend
    profiles:
      - dev

  # ============================================
  # DATABASE ADMIN (Development)
  # ============================================
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: openbiz_phpmyadmin
    environment:
      PMA_HOST: mysql
      PMA_USER: ${DB_USERNAME:-openbiz}
      PMA_PASSWORD: ${DB_PASSWORD:-secret}
    ports:
      - "8081:80"
    depends_on:
      - mysql
    networks:
      - openbiz_backend
    profiles:
      - dev

# ============================================
# NETWORKS
# ============================================
networks:
  openbiz_frontend:
    driver: bridge
  openbiz_backend:
    driver: bridge
  openbiz_storage:
    driver: bridge

# ============================================
# VOLUMES
# ============================================
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  meilisearch_data:
    driver: local
